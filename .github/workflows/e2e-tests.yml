name: E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_DB: bridge_test
          POSTGRES_USER: test_user  
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Foundry
      uses: foundry-rs/foundry-toolchain@v1

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Start test networks
      run: |
        # Start Anvil instances
        anvil --port 8545 --chain-id 31337 &
        anvil --port 8546 --chain-id 31338 &
        sleep 5

    - name: Deploy test contracts
      run: ./tests/e2e/deploy-test-contracts.sh

    - name: Run E2E tests
      run: |
        cd tests/e2e
        go test -v -timeout=10m ./...

    - name: Upload test results
      uses: actions/upload-artifact@v3
      with:
        name: e2e-test-results
        path: tests/e2e/test-results/
