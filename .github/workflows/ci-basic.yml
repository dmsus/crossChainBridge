name: CI - Cross-Chain Bridge

on:
  push:
    branches: [ develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Быстрые проверки для PR
  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Check file structure
      run: |
        [ -f "relayer/go.mod" ] || exit 1
        [ -f "contracts/foundry.toml" ] || exit 1
        echo "✅ Project structure is valid"

    - name: Check Markdown files
      run: find . -name "*.md" -type f | head -10

    - name: Validate YAML files
      run: |
        find . -name "*.yaml" -o -name "*.yml" | grep -v node_modules | xargs -I {} python3 -c "import yaml; yaml.safe_load(open('{}'))"

    - name: Check Kubernetes manifests
      run: |
        cd k8s
        kustomize build base/ > /dev/null
        kustomize build staging/ > /dev/null
        kustomize build production/ > /dev/null
      continue-on-error: true

  # Полное тестирование для main branch
  full-test:
    name: Full Test Suite
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Setup Foundry
      uses: foundry-rs/foundry-toolchain@v1

    - name: Run comprehensive tests
      run: |
        cd relayer
        go test -v -race -coverprofile=coverage.out ./...
        go tool cover -html=coverage.out -o coverage.html

        cd ../contracts
        forge test -vvv --fork-url ${{ secrets.SEPOLIA_RPC_URL }}
        forge test -vvv --fork-url ${{ secrets.AMOY_RPC_URL }}
      env:
        SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
        AMOY_RPC_URL: ${{ secrets.AMOY_RPC_URL }}
